#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<malloc.h>
#include<iostream>
#include<conio.h>
#include<math.h>

int main() {
	FILE * fp = fopen("sql.txt","r+b");
	FILE * data = fopen("record.txt","ab");
	int input_id,i,j;
	int pin[10];
	char buff[100],buf[100];
	char * temp1;//sql中的ID 
	char * temp2;//sql中的Pw
	char * temp3;//sql中的Mon
	bool flag = false;
	char * id_addr;//临时变量记录buf指针位置
	char cho1,cho2,cho3;
	char * temp4;//临时的存取款金额

	//获取输入的ID和Pw
	printf("请输入ID: \n");
	scanf("%d",&input_id);


	//判断账户和密码
	while(fgets(buf,100,fp)!=NULL) { //循环遍历每一行
		id_addr = buf;
		strcpy(buff,buf);
		temp1 = strtok(buf,",");//循环分离出字符串中每个ID
		if(input_id == atoi(temp1)) { //查找特定ID
			int count = 0;
			temp2 = strtok(buff+8,",");//+8和+9结果相同
			while(1) {
				printf("\n请输入6位数密码: \n");
				int t = 0;
				for(i=0; i<6; i++) {
					pin[i] = getch();
					t += ((pin[i]-'0')*pow(10,5-i));//转化为数字
					printf("*");//不明文显示
				}
				getch();
				if(t == atoi(temp2)) {
					fclose(fp);//关闭文件，避免循环的继续导致所需要的id_addr改变
					printf("\nPassword is true ,continue please!\n");
					flag = true;
					break;
				} else {
					count++;
					printf("密码错误!\n");
				}
				if(count>=3) {
					fclose(fp);
					printf("\n输入密码错误超过三次,锁定账户");
					fprintf(data,"The ID has been freezed!\r\n");
					exit(1);
				}
			}
		}
		if(!flag) {
			fclose(fp);
			printf("此ID尚未注册");
			exit(2);
		}
	}

	//查询余额
	temp3 = strtok(id_addr+15,",");
	printf("Check the money? Y/N \n");
	scanf("%c",&cho1);//scanf只读取了一个字符，回车要处理掉
	while(getchar()!='\n');//吃掉输入y后的回车
	if(cho1 == 'Y'||'y') {
		printf("\n余额为: %s\n",temp3);//%c输出结果也相同
		fprintf(data,"Check the Money.\r\n");
	}

	//存取款
	printf("Draw the money? Y/N\n");
	scanf("%c",&cho2);
	while(getchar()!='\n');
	if(cho2 == 'Y'||'y') {
		float draw_money;
		printf("请输入要取款的金额: \n");
		scanf("%f",&draw_money);
		while(getchar()!='\n');
		if(atof(temp3)<draw_money||draw_money<=0) {
			printf("Draw money error\n");
			fprintf(data,"Draw money %.2f error!\r\n",draw_money);
		} else {
			float c = -draw_money + atof(temp3);
			//fwrite(&c,32,1,temp3);
			printf("余额为: %.2f\n",c);
			fprintf(data,"Draw money %.2f success!\r\n",draw_money);
			fprintf(data,"Now the money is: %.2f.",c);
		}
	}


	return 0;
}
